# EndBASIC
# Copyright 2020 Julio Merino
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License.  You may obtain a copy
# of the License at:
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
# License for the specific language governing permissions and limitations
# under the License.

name: Build release

on: [push, pull_request]

jobs:
    linux-armv7-rpi:
        runs-on: ubuntu-latest
        steps:
            - uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  default: true
                  target: armv7-unknown-linux-gnueabihf
            - uses: actions/checkout@v2
            - run: sudo apt install gcc-arm-linux-gnueabihf
            - run: ./.github/workflows/release.sh linux-armv7-rpi
            - uses: actions/upload-artifact@v2
              with:
                name: endbasic-linux-armv7-rpi
                path: endbasic-linux-armv7-rpi/*
                retention-days: 1

    linux-x86_64:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - run: ./.github/workflows/release.sh linux-x86_64
            - uses: actions/upload-artifact@v2
              with:
                name: endbasic-linux-x86_64
                path: endbasic-linux-x86_64/*
                retention-days: 1

    macos-x86_64:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v2
            - run: ./.github/workflows/release.sh macos-x86_64
            - uses: actions/upload-artifact@v2
              with:
                name: endbasic-macos-x86_64
                path: endbasic-macos-x86_64/*
                retention-days: 1

    windows-x86_64:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v2
            - run: choco install zip
            - run: ./.github/workflows/release.sh windows-x86_64
              shell: bash
            - uses: actions/upload-artifact@v2
              with:
                name: endbasic-windows-x86_64
                path: endbasic-windows-x86_64/*
                retention-days: 1

    create-release:
        if: startsWith(github.ref, 'refs/tags/')
        needs: [linux-armv7-rpi, linux-x86_64, macos-x86_64, windows-x86_64]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - run: ./.github/workflows/notes.sh >notes.md || touch notes.md
            - name: Fetch binary artifacts
              uses: actions/download-artifact@v2
              with:
                path: artifacts
            - name: Create release draft
              id: create_release
              uses: ncipollo/release-action@v1
              with:
                  name: Release ${{ github.ref }}
                  bodyFile: ./notes.md
                  draft: true
                  prerelease: false
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Upload tgz artifacts
              id: upload_tgzs
              uses: ncipollo/release-action@v1
              with:
                  allowUpdates: true
                  omitBody: true
                  omitName: true
                  replacesArtifacts: false
                  draft: true
                  prerelease: false
                  artifacts: "artifacts/*/*.tgz"
                  artifactContentType: application/gzip
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Upload zip artifacts
              id: upload_zips
              uses: ncipollo/release-action@v1
              with:
                  allowUpdates: true
                  omitBody: true
                  omitName: true
                  replacesArtifacts: false
                  draft: true
                  prerelease: false
                  artifacts: "artifacts/*/*.zip"
                  artifactContentType: application/zip
                  token: ${{ secrets.GITHUB_TOKEN }}
